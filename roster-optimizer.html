<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Roster Optimizer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .main-content {
            padding: 40px;
        }

        .file-upload-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 30px;
            margin: 20px 0;
        }

        .file-upload {
            background: white;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            margin: 15px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-upload:hover {
            border-color: #3498db;
            background: #f0f8ff;
        }

        .file-upload.dragover {
            border-color: #3498db;
            background: #e3f2fd;
        }

        .file-upload h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .file-upload p {
            color: #7f8c8d;
            margin: 5px 0;
        }

        .help-link {
            color: #3498db;
            text-decoration: none;
            font-weight: 500;
        }

        .help-link:hover {
            text-decoration: underline;
        }

        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s ease;
            margin: 10px 5px;
        }

        .btn:hover {
            background: #2980b9;
        }

        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        .btn.success {
            background: #27ae60;
        }

        .btn.success:hover {
            background: #229954;
        }

        .btn.secondary {
            background: #95a5a6;
        }

        .btn.secondary:hover {
            background: #7f8c8d;
        }

        .results-section {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            display: none;
        }

        .results-section.active {
            display: block;
        }

        .results-title {
            color: #2e7d32;
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .patient-list {
            background: white;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
            max-height: 400px;
            overflow-y: auto;
        }

        .patient-item {
            padding: 8px 0;
            border-bottom: 1px solid #f1f3f4;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .patient-item:last-child {
            border-bottom: none;
        }

        .patient-info {
            flex: 1;
        }

        .health-card {
            font-weight: 600;
            color: #2c3e50;
        }

        .patient-name {
            color: #7f8c8d;
            font-size: 0.9em;
        }

        .status-message {
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            display: none;
        }

        .status-message.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .status-message.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .status-message.info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #ecf0f1;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
            display: none;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            width: 0%;
            transition: width 0.3s ease;
        }

        .help-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 30px;
            margin: 30px 0;
            display: none;
        }

        .help-section.active {
            display: block;
        }

        .help-tabs {
            display: flex;
            flex-wrap: wrap;
            border-bottom: 1px solid #dee2e6;
            margin-bottom: 20px;
        }

        .help-tab {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
            font-size: 14px;
            white-space: nowrap;
        }

        .help-tab.active {
            border-bottom-color: #3498db;
            background: #e3f2fd;
        }

        .help-tab:hover {
            background: #f8f9fa;
        }

        .help-content {
            display: none;
        }

        .help-content.active {
            display: block;
        }

        .help-content h4 {
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .help-content h5 {
            color: #34495e;
            margin: 15px 0 10px 0;
        }

        .help-content p {
            color: #7f8c8d;
            line-height: 1.6;
            margin: 8px 0;
        }

        .help-content ol, .help-content ul {
            color: #7f8c8d;
            margin: 10px 0 10px 20px;
        }

        .help-content li {
            margin: 5px 0;
        }

        .footer {
            background: #2c3e50;
            color: white;
            padding: 30px;
            text-align: center;
        }

        .footer p {
            margin-bottom: 10px;
        }

        .privacy-notice {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            padding: 25px;
            margin: 20px 0;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 10px 20px rgba(46, 204, 113, 0.2);
        }

        .privacy-notice h3 {
            margin-bottom: 15px;
            font-size: 1.4em;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .privacy-notice p {
            margin: 8px 0;
            font-size: 1.1em;
            opacity: 0.95;
        }

        .privacy-badges {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .privacy-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        input[type="file"] {
            display: none;
        }

        .analysis-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .analysis-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .analysis-option {
            display: flex;
            align-items: flex-start;
            padding: 15px;
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .analysis-option:hover {
            border-color: #3498db;
            background: #f8f9fa;
        }

        .analysis-option input[type="radio"] {
            margin-right: 12px;
            margin-top: 2px;
        }

        .analysis-option input[type="radio"]:checked + .option-text {
            color: #2c3e50;
        }

        .analysis-option:has(input[type="radio"]:checked) {
            border-color: #3498db;
            background: #e3f2fd;
        }

        .option-text {
            flex: 1;
        }

        .option-text strong {
            display: block;
            margin-bottom: 5px;
            color: #2c3e50;
        }

        .option-text small {
            color: #6c757d;
            line-height: 1.4;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>The Roster Optimizer</h1>
            <p>Compare your EMR roster with the Ministry roster to identify patients for q200 rostering</p>
        </div>

        <div class="main-content">
            <div class="file-upload-section">
                <div style="text-align: center; margin-bottom: 20px;">
                    <p><strong>Need help getting your EMR report?</strong> <a href="#" class="help-link" id="showHelp">Click here for EMR instructions</a></p>
                </div>
                
                <div class="file-upload" id="emrUpload">
                    <h3>📁 Step 1: Upload Your EMR Report</h3>
                    <p>Upload the patient report from your EMR system</p>
                    <p><small>Supported format: CSV (.csv) only</small></p>
                    <input type="file" id="emrFileInput" accept=".csv">
                </div>

                <div style="text-align: center; margin: 20px 0;">
                    <p><strong>Need help getting your Ministry roster file?</strong> <a href="#" class="help-link" id="showMinistryHelp">Click here for MOH download instructions</a></p>
                </div>
                
                <div class="file-upload" id="ministryUpload">
                    <h3>🏛️ Step 2: Upload Ministry Roster File</h3>
                    <p>Upload your Ministry of Health roster file</p>
                    <p><small>Supported format: XML (.xml)</small></p>
                    <input type="file" id="ministryFileInput" accept=".xml">
                </div>

                <div class="analysis-section">
                    <h3>Analysis</h3>
                    <p>Compare EMR roster with Ministry roster to find discrepancies.</p>
                </div>

                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn success" id="runAnalysis" disabled>Run Analysis</button>
                    <button class="btn secondary" id="clearFiles">Clear Files</button>
                </div>
            </div>

            <div class="progress-bar" id="progressBar">
                <div class="progress-fill" id="progressFill"></div>
            </div>

            <div class="status-message" id="statusMessage"></div>

            <div class="results-section" id="resultsSection">
                <h3>Analysis Results</h3>
                <div id="resultsContent">
                    <!-- Results will be dynamically populated -->
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn" id="exportExcel">Export to Excel</button>
                    <button class="btn" id="exportCSV">Export to CSV</button>
                    <button class="btn secondary" id="newAnalysis">New Analysis</button>
                </div>
            </div>

            <div class="help-section" id="helpSection">
                <div style="background-color: #e8f4fd; border: 2px solid #2196F3; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <h4 style="color: #1976D2; margin: 0 0 10px 0;">📋 Important File Format Notice</h4>
                    <p style="margin: 0; font-weight: bold; color: #1976D2;">This tool only accepts CSV files. If your EMR exports to Excel format, please save it as CSV before uploading.</p>
                </div>
                
                <div style="background-color: #f0f8f0; border: 2px solid #4CAF50; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <h4 style="color: #2E7D32; margin: 0 0 10px 0;">🎯 What This Tool Does</h4>
                    <p style="margin: 0; color: #2E7D32;">This tool compares your EMR patient roster with the Ministry of Health roster to identify patients who are in your EMR but not rostered with the Ministry. These patients may be candidates for q200 rostering.</p>
                </div>
                
                <div class="help-tabs">
                    <div class="help-tab active" data-tab="overview">Overview</div>
                    <div class="help-tab" data-tab="oscar">OSCAR PRO</div>
                    <div class="help-tab" data-tab="accuro">QHR ACCURO</div>
                    <div class="help-tab" data-tab="telus-chr">TELUS CHR</div>
                    <div class="help-tab" data-tab="telus-pss">TELUS PSS</div>
                    <div class="help-tab" data-tab="ministry">Ministry File</div>
                    <div class="help-tab" data-tab="troubleshooting">Troubleshooting</div>
                </div>

                <div class="help-content active" id="overview">
                    <h4>📖 How to Use This Tool</h4>
                    <ol>
                        <li><strong>Get Your EMR Report:</strong> Export a patient list from your EMR system as a CSV file only (see EMR-specific instructions below)</li>
                        <li><strong>Get Your Ministry Roster:</strong> Download your roster capitation report from MC EDT as an XML file (see Ministry instructions below)</li>
                        <li><strong>Upload Files:</strong> Upload both files to this tool</li>
                        <li><strong>Run Analysis:</strong> Click "Run Analysis" to compare the files</li>
                        <li><strong>Review Results:</strong> The tool will show you patients who are in your EMR but not on the Ministry roster</li>
                        <li><strong>Export Results:</strong> Download the results as CSV or Excel for further review</li>
                    </ol>
                    
                    <h4>📊 Understanding the Results</h4>
                    <ul>
                        <li><strong>EMR Only:</strong> Patients in your EMR but not on the Ministry roster - these may be candidates for q200 rostering</li>
                        <li><strong>Ministry Only:</strong> Patients on the Ministry roster but not in your EMR - these may need to be removed from your roster</li>
                        <li><strong>Non-OHIP Identifiers:</strong> Patients with non-standard health card formats (RAMQ, etc.)</li>
                    </ul>
                    
                    <h4>⚠️ Important Notes</h4>
                    <ul>
                        <li>This tool processes data locally in your browser - no data is sent to external servers</li>
                        <li>Results are based on health card number matching</li>
                        <li>Always verify results before making roster changes</li>
                        <li>Contact your EMR vendor if you need help exporting patient data</li>
                    </ul>
                </div>

                <div class="help-content" id="oscar">
                    <h4>OSCAR PRO: Report by Template (RbT)</h4>
                    <ol>
                        <li>In OSCAR PRO, from the main menu, click Administration > Reports > Report by Template (RbT).</li>
                        <li>In the Report by Template (RbT) window, click Add Template > Choose File.</li>
                        <li>Browse to and open your locally saved Roster Reconciliation folder, select OMD Roster Reconciliation-EMR Report – OSCAR PRO.TXT > Open > Upload & Add.</li>
                        <li>Locate and select the downloaded Report by Template (RbT) in the list, choose the physician to reconcile from the Provider Number dropdown > Run Query.</li>
                        <li>To export the patient list, click Export to CSV.</li>
                        <li>Locate the downloaded CSV file on your computer and move it to the EMR Report subfolder inside your locally saved Roster Reconciliation folder.</li>
                        <li><strong>Important:</strong> Export as CSV format only - do not use Excel format.</li>
                    </ol>
                </div>

                <div class="help-content" id="accuro">
                    <h4>QHR ACCURO®: Query</h4>
                    <ol>
                        <li>In Accuro, click the Accuro Menu > hover on Reports > click Query Builder (Alerts).</li>
                        <li>In the Alert Definitions window, click the Cloud icon (Alert Publisher).</li>
                        <li>In the Alert Definition Publisher window, type Roster Reconciliation into the Search field.</li>
                        <li>In the Publisher field, select OntarioMD.</li>
                        <li>Click the magnifying glass to search the repository.</li>
                        <li>Highlight the query to download and click Download Alert.</li>
                        <li>Modify the query criteria to match your clinic's Patient Status and Roster Status definitions:
                            <ul>
                                <li>Update Patient Status (default is Active) by selecting the rule, clicking the magnifying glass icon, and updating the rule.</li>
                                <li>Update Enrolled Provider by selecting the rule, choosing the physician from the dropdown, and updating the rule.</li>
                            </ul>
                        </li>
                        <li>Run the query and export the patient list:
                            <ul>
                                <li>Click Run Report > Run.</li>
                                <li>With the Alert Matches displayed, click Export.</li>
                                <li>Deselect Encrypt, choose the EMR Report subfolder, enter a file name, and click Export.</li>
                            </ul>
                        </li>
                        <li><strong>Important:</strong> Export as CSV format only - do not use Excel format.</li>
                    </ol>
                </div>

                <div class="help-content" id="telus-chr">
                    <h4>TELUS CHR: Analytics Dashboards</h4>
                    <ol>
                        <li>In TELUS CHR, from the main menu, click Analytics.</li>
                        <li>Under Dashboards, search for and select Patient Search.</li>
                        <li>Set the Patient Search Filters:
                            <ul>
                                <li>Primary Physician: choose IS and select the physician to reconcile.</li>
                                <li>Patient Status: choose IS and select Active or your clinic's equivalent.</li>
                                <li>Patient Data Field: choose IS, start typing Enrollment, and select Enrollment |Enrollment|Status.</li>
                                <li>Patient Data Value: choose Contains, start typing Enrollment, and select the enrollment status(es) matching your clinic's definitions.</li>
                            </ul>
                        </li>
                        <li>Click the Load or Reload icon to generate the patient list.</li>
                        <li>To export the patient list, click the menu icon (Dashboard Actions).</li>
                        <li>In the Download Patient Search window, select CSV as the format and click Download.</li>
                        <li>Locate the downloaded zipped CSV file, unzip/extract it, and move the extracted file to the EMR Report subfolder.</li>
                        <li><strong>Important:</strong> Export as CSV format only - do not use Excel format.</li>
                    </ol>
                </div>

                <div class="help-content" id="telus-pss">
                    <h4>TELUS PSS: Search</h4>
                    <ol>
                        <li>In TELUS PSS, from the Records window, click Settings > Edit Searches.</li>
                        <li>In the new window, click Edit > Import Searches.</li>
                        <li>Browse to your locally saved Roster Reconciliation folder, select OMD Roster Reconciliation-EMR Report – TELUS PSS.srx, and click Choose.</li>
                        <li>Modify the search criteria to match your clinic's Patient Status and Roster Status definitions:
                            <ul>
                                <li>Update Patient Status (default is Active) by selecting the rule, clicking Edit Line, and selecting your clinic's patient status.</li>
                                <li>Update Roster Status (Member Status) by selecting the rule, clicking Edit Line, and choosing the Roster Status your clinic uses.</li>
                            </ul>
                        </li>
                        <li>Click Perform Search.</li>
                        <li>Uncheck All Doctors and select the doctor to reconcile, then click Search.</li>
                        <li>Export the patient list:
                            <ul>
                                <li>Click Report > Utilities > Save as CSV.</li>
                                <li>Save the file to the EMR Report subfolder.</li>
                            </ul>
                        </li>
                        <li><strong>Important:</strong> Export as CSV format only - do not use Excel format.</li>
                    </ol>
                </div>

                <div class="help-content" id="ministry">
                    <h4>Ministry of Health (MOH) Roster Capitation Report Download</h4>
                    <ol>
                        <li>Log in to the Medical Claims Electronic Data Transfer (MC EDT) system via the OPS BPS Secure portal.</li>
                        <li>Select the MC EDT Service (Report Download) option.</li>
                        <li>In the dropdown menus, select the Physician Name/Billing Number to reconcile and the MC EDT Service (Upload/Download) > click Access Service.</li>
                        <li>Locate the physician's most recent Roster Capitation Report (XML format).</li>
                        <li>Click Download and save the XML file. If the file downloads automatically, locate it on your computer.</li>
                        <li>Repeat the process for each physician to reconcile.</li>
                    </ol>
                    
                    <h4>📋 Important Notes for Ministry File</h4>
                    <ul>
                        <li><strong>File Format:</strong> Must be XML format (not PDF)</li>
                        <li><strong>File Name:</strong> Usually contains the physician's billing number</li>
                        <li><strong>Frequency:</strong> Download the most recent report available</li>
                        <li><strong>Multiple Physicians:</strong> You can upload multiple XML files if needed</li>
                    </ul>
                </div>

                <div class="help-content" id="troubleshooting">
                    <h4>🔧 Common Issues and Solutions</h4>
                    
                    <h5>File Upload Issues</h5>
                    <ul>
                        <li><strong>Error: "Only CSV files are supported"</strong>
                            <ul>
                                <li>Solution: Save your Excel file as CSV format before uploading</li>
                                <li>In Excel: File > Save As > CSV (Comma delimited)</li>
                            </ul>
                        </li>
                        <li><strong>Error: "Could not find health card column"</strong>
                            <ul>
                                <li>Solution: Ensure your CSV file has a column with health card numbers</li>
                                <li>Common column names: "Health Number", "HCN", "PHN", "Patient Identification Value"</li>
                            </ul>
                        </li>
                    </ul>
                    
                    <h5>Analysis Issues</h5>
                    <ul>
                        <li><strong>No results showing</strong>
                            <ul>
                                <li>Check that both files uploaded successfully</li>
                                <li>Verify the files contain patient data</li>
                                <li>Ensure health card numbers are 10-digit format</li>
                            </ul>
                        </li>
                        <li><strong>Unexpected results</strong>
                            <ul>
                                <li>Verify the files are from the same time period</li>
                                <li>Check that health card numbers are in standard OHIP format</li>
                                <li>Ensure patient status filters are appropriate</li>
                            </ul>
                        </li>
                    </ul>
                    
                    <h5>Browser Issues</h5>
                    <ul>
                        <li><strong>Tool not loading</strong>
                            <ul>
                                <li>Try refreshing the page</li>
                                <li>Clear browser cache and cookies</li>
                                <li>Try a different browser (Chrome, Firefox, Edge)</li>
                            </ul>
                        </li>
                        <li><strong>Files not uploading</strong>
                            <ul>
                                <li>Check file size (should be under 50MB)</li>
                                <li>Ensure files are not password protected</li>
                                <li>Try uploading one file at a time</li>
                            </ul>
                        </li>
                    </ul>
                    
                    <h5>Getting Help</h5>
                    <ul>
                        <li><strong>EMR Issues:</strong> Contact your EMR vendor for help with data export</li>
                        <li><strong>Ministry File Issues:</strong> Contact MC EDT support for help with roster downloads</li>
                        <li><strong>Tool Issues:</strong> Try the troubleshooting steps above first</li>
                    </ul>
                </div>

            </div>

            <div class="help-section" id="ministryHelpSection">
                <div class="help-content active">
                    <h4>Ministry of Health (MOH) Roster Capitation Report Download</h4>
                    <ol>
                        <li>Log in to the Medical Claims Electronic Data Transfer (MC EDT) system via the OPS BPS Secure portal.</li>
                        <li>Select the MC EDT Service (Report Download) option.</li>
                        <li>In the dropdown menus, select the Physician Name/Billing Number to reconcile and the MC EDT Service (Upload/Download) > click Access Service.</li>
                        <li>Locate the physician's most recent Roster Capitation Report (XML format).</li>
                        <li>Click Download and save the XML file to the MOH Report subfolder within your Roster Reconciliation folder. If the file downloads automatically, locate it on your computer and move it to the MOH Report subfolder.</li>
                        <li>Repeat the process for each physician to reconcile.</li>
                    </ol>
                    
                    <h5>Important Tips:</h5>
                    <ul>
                        <li><strong>File Format:</strong> The Roster Capitation Report is available as both a PDF and an XML file. The Roster Optimizer requires using the XML version.</li>
                        <li><strong>File Naming:</strong> The Roster Capitation Report(s) include the physician's billing number in the file name. To avoid confusion, you can save it with a clear name such as Dr. X-Roster-Aug2025.xml when downloading.</li>
                        <li><strong>Multiple Physicians:</strong> If you have multiple physicians, you'll need to download separate roster reports for each one.</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Comprehensive Guide Section -->
        <div class="help-section" style="margin-top: 40px;">
            <h3 style="color: #2c3e50; margin-bottom: 20px; text-align: center;">📚 Complete Roster Reconciliation Guide</h3>
            
            <div style="background-color: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                <h4 style="color: #856404; margin: 0 0 10px 0;">🔍 Searchable Help Guide</h4>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="text" id="helpSearch" placeholder="Search help content..." style="flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                    <button onclick="searchHelp()" style="padding: 8px 16px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">Search</button>
                    <button onclick="clearSearch()" style="padding: 8px 16px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">Clear</button>
                </div>
            </div>
            
            <div id="helpContent">
                <div class="help-section" data-keywords="introduction overview purpose">
                    <h5>Introduction</h5>
                    <p>The Roster Reconciliation process helps family physicians identify patients who are in their EMR system but not properly rostered with the Ministry of Health. This tool automates the comparison process to help you optimize your patient roster and ensure proper capitation payments.</p>
                </div>

                <div class="help-section" data-keywords="prerequisites requirements setup">
                    <h5>Prerequisites</h5>
                    <ul>
                        <li>Access to your EMR system with patient export capabilities</li>
                        <li>MC EDT (Medical Claims Electronic Data Transfer) account access</li>
                        <li>Modern web browser (Chrome, Firefox, Edge, Safari)</li>
                        <li>Patient data export permissions in your EMR</li>
                    </ul>
                </div>

                <div class="help-section" data-keywords="emr export patient data csv">
                    <h5>EMR Data Export Requirements</h5>
                    <p>Your EMR export must include:</p>
                    <ul>
                        <li><strong>Health Card Numbers:</strong> 10-digit OHIP numbers (primary identifier)</li>
                        <li><strong>Patient Names:</strong> Full names for identification</li>
                        <li><strong>Active Patients Only:</strong> Exclude inactive or deceased patients</li>
                        <li><strong>CSV Format:</strong> Comma-separated values for compatibility</li>
                    </ul>
                </div>

                <div class="help-section" data-keywords="oscar pro report template rbt">
                    <h5>OSCAR PRO: Detailed Export Instructions</h5>
                    <ol>
                        <li><strong>Access Report by Template:</strong>
                            <ul>
                                <li>From main menu: Administration → Reports → Report by Template (RbT)</li>
                                <li>Click "Add Template" → "Choose File"</li>
                            </ul>
                        </li>
                        <li><strong>Upload Template:</strong>
                            <ul>
                                <li>Browse to your Roster Reconciliation folder</li>
                                <li>Select "OMD Roster Reconciliation-EMR Report – OSCAR PRO.TXT"</li>
                                <li>Click "Open" → "Upload & Add"</li>
                            </ul>
                        </li>
                        <li><strong>Run Report:</strong>
                            <ul>
                                <li>Select the uploaded template from the list</li>
                                <li>Choose physician from "Provider Number" dropdown</li>
                                <li>Click "Run Query"</li>
                            </ul>
                        </li>
                        <li><strong>Export Data:</strong>
                            <ul>
                                <li>Click "Export to CSV"</li>
                                <li>Save file with descriptive name (e.g., "DrSmith_Patients_2024.csv")</li>
                            </ul>
                        </li>
                    </ol>
                </div>

                <div class="help-section" data-keywords="qhr accuro query builder alerts">
                    <h5>QHR ACCURO: Detailed Export Instructions</h5>
                    <ol>
                        <li><strong>Access Query Builder:</strong>
                            <ul>
                                <li>Click Accuro Menu → Reports → Query Builder (Alerts)</li>
                                <li>Click the Cloud icon (Alert Publisher)</li>
                            </ul>
                        </li>
                        <li><strong>Search Repository:</strong>
                            <ul>
                                <li>Type "Roster Reconciliation" in Search field</li>
                                <li>Select "OntarioMD" in Publisher field</li>
                                <li>Click magnifying glass to search</li>
                            </ul>
                        </li>
                        <li><strong>Download Query:</strong>
                            <ul>
                                <li>Highlight the query in results</li>
                                <li>Click "Download Alert"</li>
                            </ul>
                        </li>
                        <li><strong>Modify Criteria:</strong>
                            <ul>
                                <li>Update Patient Status (default: Active)</li>
                                <li>Update Enrolled Provider (select your physician)</li>
                                <li>Update rules as needed for your clinic</li>
                            </ul>
                        </li>
                        <li><strong>Run and Export:</strong>
                            <ul>
                                <li>Click "Run Report" → "Run"</li>
                                <li>With results displayed, click "Export"</li>
                                <li>Deselect "Encrypt", choose folder, enter filename</li>
                                <li>Click "Export"</li>
                            </ul>
                        </li>
                    </ol>
                </div>

                <div class="help-section" data-keywords="telus chr analytics dashboard patient search">
                    <h5>TELUS CHR: Detailed Export Instructions</h5>
                    <ol>
                        <li><strong>Access Analytics:</strong>
                            <ul>
                                <li>From main menu: Click "Analytics"</li>
                                <li>Under Dashboards: Search for "Patient Search"</li>
                                <li>Select "Patient Search" dashboard</li>
                            </ul>
                        </li>
                        <li><strong>Set Filters:</strong>
                            <ul>
                                <li><strong>Primary Physician:</strong> Choose "IS" → Select your physician</li>
                                <li><strong>Patient Status:</strong> Choose "IS" → Select "Active" (or your clinic's equivalent)</li>
                                <li><strong>Patient Data Field:</strong> Choose "IS" → Type "Enrollment" → Select "Enrollment|Enrollment|Status"</li>
                                <li><strong>Patient Data Value:</strong> Choose "Contains" → Type "Enrollment" → Select appropriate enrollment status</li>
                            </ul>
                        </li>
                        <li><strong>Generate Report:</strong>
                            <ul>
                                <li>Click Load/Reload icon to generate patient list</li>
                                <li>Verify the results match your expectations</li>
                            </ul>
                        </li>
                        <li><strong>Export Data:</strong>
                            <ul>
                                <li>Click menu icon (Dashboard Actions)</li>
                                <li>In Download window: Select "CSV" format</li>
                                <li>Click "Download"</li>
                                <li>Locate downloaded zipped file and extract it</li>
                            </ul>
                        </li>
                    </ol>
                </div>

                <div class="help-section" data-keywords="telus pss search edit searches">
                    <h5>TELUS PSS: Detailed Export Instructions</h5>
                    <ol>
                        <li><strong>Access Search Editor:</strong>
                            <ul>
                                <li>From Records window: Click "Settings" → "Edit Searches"</li>
                                <li>Click "Edit" → "Import Searches"</li>
                            </ul>
                        </li>
                        <li><strong>Import Search Template:</strong>
                            <ul>
                                <li>Browse to Roster Reconciliation folder</li>
                                <li>Select "OMD Roster Reconciliation-EMR Report – TELUS PSS.srx"</li>
                                <li>Click "Choose"</li>
                            </ul>
                        </li>
                        <li><strong>Modify Search Criteria:</strong>
                            <ul>
                                <li><strong>Patient Status:</strong> Select rule → Click "Edit Line" → Choose your clinic's patient status</li>
                                <li><strong>Roster Status:</strong> Select rule → Click "Edit Line" → Choose appropriate roster status</li>
                            </ul>
                        </li>
                        <li><strong>Perform Search:</strong>
                            <ul>
                                <li>Click "Perform Search"</li>
                                <li>Uncheck "All Doctors"</li>
                                <li>Select specific doctor to reconcile</li>
                                <li>Click "Search"</li>
                            </ul>
                        </li>
                        <li><strong>Export Results:</strong>
                            <ul>
                                <li>Click "Report" → "Utilities" → "Save as CSV"</li>
                                <li>Save to appropriate folder</li>
                                <li>Note: File may save as .txt - rename to .csv if needed</li>
                            </ul>
                        </li>
                    </ol>
                </div>

                <div class="help-section" data-keywords="ministry mcedt roster capitation xml">
                    <h5>Ministry of Health Roster Download</h5>
                    <ol>
                        <li><strong>Access MC EDT:</strong>
                            <ul>
                                <li>Log in to OPS BPS Secure portal</li>
                                <li>Navigate to MC EDT system</li>
                            </ul>
                        </li>
                        <li><strong>Select Service:</strong>
                            <ul>
                                <li>Choose "MC EDT Service (Report Download)"</li>
                                <li>Select physician name/billing number from dropdown</li>
                                <li>Choose "MC EDT Service (Upload/Download)"</li>
                                <li>Click "Access Service"</li>
                            </ul>
                        </li>
                        <li><strong>Download Roster Report:</strong>
                            <ul>
                                <li>Locate "Roster Capitation Report" (XML format)</li>
                                <li>Click "Download"</li>
                                <li>Save file with clear name (e.g., "DrSmith_Roster_2024.xml")</li>
                            </ul>
                        </li>
                        <li><strong>Important Notes:</strong>
                            <ul>
                                <li>Must download XML format (not PDF)</li>
                                <li>File contains physician's billing number in filename</li>
                                <li>Download most recent report available</li>
                                <li>Repeat for each physician if multiple</li>
                            </ul>
                        </li>
                    </ol>
                </div>

                <div class="help-section" data-keywords="analysis results interpretation understanding">
                    <h5>Understanding Analysis Results</h5>
                    
                    <h6>EMR Only Patients</h6>
                    <p>These patients are in your EMR system but not on the Ministry roster. They may be candidates for q200 rostering if they meet the criteria:</p>
                    <ul>
                        <li>Regular patients (not walk-ins)</li>
                        <li>Not focused practice specialists</li>
                        <li>Meet Ministry rostering requirements</li>
                    </ul>

                    <h6>Ministry Only Patients</h6>
                    <p>These patients are on the Ministry roster but not in your EMR. Consider:</p>
                    <ul>
                        <li>Patients who have left your practice</li>
                        <li>Patients who should be removed from roster</li>
                        <li>Data entry errors in either system</li>
                    </ul>

                    <h6>Non-OHIP Identifiers</h6>
                    <p>Patients with non-standard health card formats:</p>
                    <ul>
                        <li>RAMQ (Quebec) patients</li>
                        <li>Out-of-province patients</li>
                        <li>Patients with temporary health numbers</li>
                    </ul>
                </div>

                <div class="help-section" data-keywords="troubleshooting common problems errors">
                    <h5>Advanced Troubleshooting</h5>
                    
                    <h6>File Format Issues</h6>
                    <ul>
                        <li><strong>Excel files not working:</strong> Save as CSV format before uploading</li>
                        <li><strong>Corrupted CSV files:</strong> Re-export from EMR with proper encoding</li>
                        <li><strong>Large files:</strong> Split into smaller files if over 50MB</li>
                    </ul>

                    <h6>Data Quality Issues</h6>
                    <ul>
                        <li><strong>Missing health card numbers:</strong> Check EMR export settings</li>
                        <li><strong>Invalid health card formats:</strong> Verify 10-digit OHIP numbers</li>
                        <li><strong>Duplicate patients:</strong> Clean data before analysis</li>
                    </ul>

                    <h6>Analysis Issues</h6>
                    <ul>
                        <li><strong>No matches found:</strong> Verify both files contain valid data</li>
                        <li><strong>Unexpected results:</strong> Check file dates and patient status filters</li>
                        <li><strong>Missing patients:</strong> Ensure export includes all active patients</li>
                    </ul>
                </div>

                <div class="help-section" data-keywords="best practices recommendations tips">
                    <h5>Best Practices</h5>
                    
                    <h6>Data Export</h6>
                    <ul>
                        <li>Export data monthly for regular reconciliation</li>
                        <li>Use consistent date ranges for both EMR and Ministry files</li>
                        <li>Verify patient status filters match your practice</li>
                        <li>Keep backup copies of exported files</li>
                    </ul>

                    <h6>Analysis Process</h6>
                    <ul>
                        <li>Review results carefully before making roster changes</li>
                        <li>Verify patient information before rostering</li>
                        <li>Document decisions for audit purposes</li>
                        <li>Follow up on rostered patients to ensure proper enrollment</li>
                    </ul>

                    <h6>Security and Privacy</h6>
                    <ul>
                        <li>This tool processes data locally - no data is transmitted</li>
                        <li>Delete uploaded files after analysis if desired</li>
                        <li>Ensure secure handling of patient data</li>
                        <li>Follow your organization's privacy policies</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="privacy-notice">
            <h3>🔒 Your Data is 100% Private & Secure</h3>
            <p><strong>This tool runs entirely in your web browser and never shares your PHI data.</strong></p>
            <p>All processing happens locally on your computer - no data is sent to external servers or third parties.</p>
            <div class="privacy-badges">
                <div class="privacy-badge">🛡️ Local Processing Only</div>
                <div class="privacy-badge">🚫 No Data Sharing</div>
                <div class="privacy-badge">🔐 PHI Protected</div>
                <div class="privacy-badge">📱 Works Offline</div>
            </div>
        </div>

        <div class="footer">
            <p><strong>The Roster Optimizer v1.0.0</strong></p>
            <p>Compare your EMR roster with the Ministry roster to identify patients for q200 rostering</p>
            <p>© 2025 Dr. Kevin Brophy with support from OntarioMD, OMA, SGFP, and Dr. Alex Duong. All rights reserved.</p>
        </div>
    </div>

    <script>
        // Global variables
        let emrFile = null;
        let ministryFile = null;
        let analysisResults = [];
        let mohOnlyResults = [];
        let nonOHIPResults = [];
        let rosterEndResults = []; // Patients who have come off the ministry roster
        let newMinistryPatients = []; // New patients added to ministry roster

        // DOM elements
        const emrUpload = document.getElementById('emrUpload');
        const emrFileInput = document.getElementById('emrFileInput');
        const ministryUpload = document.getElementById('ministryUpload');
        const ministryFileInput = document.getElementById('ministryFileInput');
        const runAnalysisBtn = document.getElementById('runAnalysis');
        const clearFilesBtn = document.getElementById('clearFiles');
        const progressBar = document.getElementById('progressBar');
        const progressFill = document.getElementById('progressFill');
        const statusMessage = document.getElementById('statusMessage');
        const resultsSection = document.getElementById('resultsSection');
        const patientList = document.getElementById('patientList');
        const exportExcelBtn = document.getElementById('exportExcel');
        const exportCSVBtn = document.getElementById('exportCSV');
        const newAnalysisBtn = document.getElementById('newAnalysis');
        const showHelpBtn = document.getElementById('showHelp');
        const showMinistryHelpBtn = document.getElementById('showMinistryHelp');
        const helpSection = document.getElementById('helpSection');
        const ministryHelpSection = document.getElementById('ministryHelpSection');
        const helpTabs = document.querySelectorAll('.help-tab');
        const helpContents = document.querySelectorAll('.help-content');

        // Event listeners
        emrUpload.addEventListener('click', () => emrFileInput.click());
        emrUpload.addEventListener('dragover', handleDragOver);
        emrUpload.addEventListener('dragleave', handleDragLeave);
        emrUpload.addEventListener('drop', (e) => handleDrop(e, 'emr'));
        emrFileInput.addEventListener('change', (e) => handleFileSelect(e, 'emr'));

        ministryUpload.addEventListener('click', () => ministryFileInput.click());
        ministryUpload.addEventListener('dragover', handleDragOver);
        ministryUpload.addEventListener('dragleave', handleDragLeave);
        ministryUpload.addEventListener('drop', (e) => handleDrop(e, 'ministry'));
        ministryFileInput.addEventListener('change', (e) => handleFileSelect(e, 'ministry'));

        runAnalysisBtn.addEventListener('click', runAnalysis);
        clearFilesBtn.addEventListener('click', clearFiles);
        exportExcelBtn.addEventListener('click', () => exportResults('excel'));
        exportCSVBtn.addEventListener('click', () => exportResults('csv'));
        newAnalysisBtn.addEventListener('click', newAnalysis);
        showHelpBtn.addEventListener('click', toggleHelp);
        showMinistryHelpBtn.addEventListener('click', toggleMinistryHelp);

        // Help tab handling
        helpTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.dataset.tab;
                helpTabs.forEach(t => t.classList.remove('active'));
                helpContents.forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tabId).classList.add('active');
            });
        });

        // File handling functions
        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
        }

        function handleDrop(e, type) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files);
            if (files.length > 0) {
                handleFile(files[0], type);
            }
        }

        function handleFileSelect(e, type) {
            const files = Array.from(e.target.files);
            if (files.length > 0) {
                handleFile(files[0], type);
            }
        }

        function handleFile(file, type) {
            if (type === 'emr') {
                emrFile = file;
                showStatus(`✅ EMR file loaded: ${file.name}`, 'success');
                updateFileStatus('emr', file.name);
            } else if (type === 'ministry') {
                ministryFile = file;
                showStatus(`✅ Ministry file loaded: ${file.name}`, 'success');
                updateFileStatus('ministry', file.name);
            }
            updateRunButton();
        }

        function updateFileStatus(type, fileName) {
            const uploadElement = type === 'emr' ? emrUpload : ministryUpload;
            const statusElement = uploadElement.querySelector('.file-status') || createFileStatusElement(uploadElement);
            statusElement.textContent = `📁 ${fileName}`;
            statusElement.style.color = '#27ae60';
            statusElement.style.fontWeight = '600';
        }

        function createFileStatusElement(uploadElement) {
            const statusElement = document.createElement('div');
            statusElement.className = 'file-status';
            statusElement.style.marginTop = '10px';
            statusElement.style.padding = '8px';
            statusElement.style.backgroundColor = '#f8f9fa';
            statusElement.style.borderRadius = '4px';
            statusElement.style.fontSize = '0.9em';
            uploadElement.appendChild(statusElement);
            return statusElement;
        }

        function updateRunButton() {
            runAnalysisBtn.disabled = !(emrFile && ministryFile);
            
            // Show status when both files are ready
            if (emrFile && ministryFile) {
                showStatus('Both files ready! Click "Run Analysis" to compare your rosters.', 'success');
            } else {
                // Show what's still needed
                const missing = [];
                if (!emrFile) missing.push('EMR file');
                if (!ministryFile) missing.push('Ministry file');
                if (missing.length > 0) {
                    showStatus(`Still need: ${missing.join(' and ')}`, 'info');
                }
            }
        }

        function clearFiles() {
            emrFile = null;
            ministryFile = null;
            analysisResults = [];
            mohOnlyResults = [];
            nonOHIPResults = [];
            rosterEndResults = [];
            newMinistryPatients = [];
            emrFileInput.value = '';
            ministryFileInput.value = '';
            
            // Clear visual file status indicators
            const emrStatus = emrUpload.querySelector('.file-status');
            const ministryStatus = ministryUpload.querySelector('.file-status');
            if (emrStatus) emrStatus.remove();
            if (ministryStatus) ministryStatus.remove();
            
            resultsSection.classList.remove('active');
            updateRunButton();
            showStatus('Files cleared - ready for new uploads', 'info');
        }

        function runAnalysis() {
            if (!emrFile || !ministryFile) {
                showStatus('Please upload both files before running analysis', 'error');
                return;
            }

            showProgress();
            showStatus('Analyzing files...', 'info');

            // Simulate analysis progress
            let progress = 0;
            const interval = setInterval(() => {
                progress += Math.random() * 20;
                if (progress >= 100) {
                    progress = 100;
                    clearInterval(interval);
                    completeAnalysis();
                }
                updateProgress(progress);
            }, 200);
        }

        function showProgress() {
            progressBar.style.display = 'block';
            progressFill.style.width = '0%';
        }

        function updateProgress(percent) {
            progressFill.style.width = percent + '%';
        }

        function completeAnalysis() {
            progressBar.style.display = 'none';
            
            // Parse the actual files
            parseFilesAndCompare();
        }

        async function parseFilesAndCompare() {
            try {
                showStatus('Parsing EMR file...', 'info');
                
                // Parse EMR file
                const emrPatients = await parseEMRFile(emrFile);
                showStatus(`Found ${emrPatients.length} patients in EMR file`, 'info');
                
                showStatus('Parsing Ministry file...', 'info');
                
                // Parse Ministry file
                const ministryData = await parseMinistryFile(ministryFile);
                const ministryHealthCards = ministryData.activePatients;
                const newPatientsFromMinistry = ministryData.newPatients;
                const rosterEndPatients = ministryData.rosterEndPatients;
                const ministryStats = ministryData.statistics;
                
                showStatus(`Found ${ministryHealthCards.length} active patients in Ministry roster (${newPatientsFromMinistry.length} new, ${rosterEndPatients.length} came off roster)`, 'info');
                
                showStatus('Comparing files...', 'info');
                
                // Always run comparison analysis (EMR-only and MOH-only, no Non-OHIP)
                const analysisType = 'all';
                
                // Extract health card numbers from Ministry data for comparison
                const ministryHealthCardNumbers = ministryHealthCards.map(patient => 
                    typeof patient === 'string' ? patient : patient['Health Number']
                );
                
                // Debug logging
                console.log('Comparison Debug:', {
                    analysisType: analysisType,
                    emrPatients: emrPatients.length,
                    ministryPatients: ministryHealthCards.length,
                    ministryHealthCards: ministryHealthCardNumbers.slice(0, 5), // First 5
                    emrHealthCards: emrPatients.slice(0, 5).map(p => p.healthCard), // First 5
                    sampleMinistryData: ministryHealthCards.slice(0, 3), // First 3 ministry objects
                    sampleEMRData: emrPatients.slice(0, 3) // First 3 EMR objects
                });
                
                // Check for exact matches
                const exactMatches = [];
                for (let i = 0; i < Math.min(5, emrPatients.length); i++) {
                    const emrCard = emrPatients[i].healthCard;
                    const isInMinistry = ministryHealthCardNumbers.includes(emrCard);
                    exactMatches.push({
                        emrCard: emrCard,
                        isInMinistry: isInMinistry,
                        ministryMatch: ministryHealthCardNumbers.find(m => m === emrCard),
                        emrCardLength: emrCard.length,
                        emrCardType: typeof emrCard
                    });
                }
                console.log('Exact Match Check:', exactMatches);
                
                // Check if any EMR cards are found in Ministry
                const foundInMinistry = emrPatients.filter(patient => 
                    ministryHealthCardNumbers.includes(patient.healthCard)
                );
                console.log(`EMR patients found in Ministry: ${foundInMinistry.length} out of ${emrPatients.length}`);
                
                // Check if any Ministry cards are found in EMR
                const foundInEMR = ministryHealthCards.filter(patient => {
                    const healthCard = patient['Health Number'];
                    return emrPatients.some(emr => emr.healthCard === healthCard);
                });
                console.log(`Ministry patients found in EMR: ${foundInEMR.length} out of ${ministryHealthCards.length}`);
                
                // Debug: Show sample EMR and Ministry health cards for comparison
                console.log('Sample EMR health cards:', emrPatients.slice(0, 5).map(p => p.healthCard));
                console.log('Sample Ministry health cards:', ministryHealthCardNumbers.slice(0, 5));
                
                // Debug: Check if there are any exact matches
                const sampleEMRCards = emrPatients.slice(0, 10).map(p => p.healthCard);
                const sampleMinistryCards = ministryHealthCardNumbers.slice(0, 10);
                const intersection = sampleEMRCards.filter(card => sampleMinistryCards.includes(card));
                console.log('Sample intersection (should have matches):', intersection);
                
                // Debug: Manual comparison test
                console.log('=== MANUAL COMPARISON TEST ===');
                console.log('First 3 EMR cards:', sampleEMRCards.slice(0, 3));
                console.log('First 3 Ministry cards:', sampleMinistryCards.slice(0, 3));
                
                // Test if any EMR card exists in Ministry
                for (let i = 0; i < Math.min(3, sampleEMRCards.length); i++) {
                    const emrCard = sampleEMRCards[i];
                    const foundInMinistry = ministryHealthCardNumbers.includes(emrCard);
                    console.log(`EMR card "${emrCard}" found in Ministry: ${foundInMinistry}`);
                    
                    // If not found, check if there's a similar one
                    if (!foundInMinistry) {
                        const similar = ministryHealthCardNumbers.filter(m => 
                            m.includes(emrCard) || emrCard.includes(m)
                        );
                        if (similar.length > 0) {
                            console.log(`  Similar Ministry cards: ${similar.slice(0, 3).join(', ')}`);
                        }
                    }
                }
                
                // Test if any Ministry card exists in EMR
                for (let i = 0; i < Math.min(3, sampleMinistryCards.length); i++) {
                    const ministryCard = sampleMinistryCards[i];
                    const foundInEMR = emrPatients.some(emr => emr.healthCard === ministryCard);
                    console.log(`Ministry card "${ministryCard}" found in EMR: ${foundInEMR}`);
                }
                
                // IMPROVED COMPARISON APPROACH WITH BETTER ERROR HANDLING
                console.log('=== IMPROVED COMPARISON APPROACH ===');
                
                // First, let's see what we actually have
                console.log('EMR Patients Count:', emrPatients.length);
                console.log('Ministry Patients Count:', ministryHealthCards.length);
                console.log('First EMR Patient:', emrPatients[0]);
                console.log('First Ministry Patient:', ministryHealthCards[0]);
                
                // Create simple arrays of health card numbers with validation
                const emrHealthCardsArray = [];
                const ministryHealthCardsArray = [];
                
                // Extract EMR health cards with validation
                for (let i = 0; i < emrPatients.length; i++) {
                    const healthCard = emrPatients[i].healthCard;
                    if (healthCard && typeof healthCard === 'string' && healthCard.trim().length > 0) {
                        emrHealthCardsArray.push(healthCard.trim());
                    }
                }
                
                // Extract Ministry health cards with validation
                for (let i = 0; i < ministryHealthCards.length; i++) {
                    const healthCard = ministryHealthCards[i]['Health Number'];
                    if (healthCard && typeof healthCard === 'string' && healthCard.trim().length > 0) {
                        ministryHealthCardsArray.push(healthCard.trim());
                    }
                }
                
                console.log('EMR Health Cards (first 5):', emrHealthCardsArray.slice(0, 5));
                console.log('Ministry Health Cards (first 5):', ministryHealthCardsArray.slice(0, 5));
                
                // Validate that we have data to compare
                if (emrHealthCardsArray.length === 0) {
                    throw new Error('No valid health card numbers found in EMR file');
                }
                if (ministryHealthCardsArray.length === 0) {
                    throw new Error('No valid health card numbers found in Ministry file');
                }
                
                // Improved comparison using validated arrays
                if (analysisType === 'emr-only' || analysisType === 'all') {
                    analysisResults = [];
                    for (let i = 0; i < emrPatients.length; i++) {
                        const emrCard = emrPatients[i].healthCard;
                        if (emrCard && typeof emrCard === 'string' && emrCard.trim().length > 0) {
                            const trimmedCard = emrCard.trim();
                            // Use includes for better performance
                            if (!ministryHealthCardsArray.includes(trimmedCard)) {
                                analysisResults.push(emrPatients[i]);
                            }
                        }
                    }
                    console.log(`EMR-Only Results: ${analysisResults.length} patients`);
                }
                
                // Improved comparison using validated arrays
                if (analysisType === 'moh-only' || analysisType === 'all') {
                    mohOnlyResults = [];
                    for (let i = 0; i < ministryHealthCards.length; i++) {
                        const ministryCard = ministryHealthCards[i]['Health Number'];
                        if (ministryCard && typeof ministryCard === 'string' && ministryCard.trim().length > 0) {
                            const trimmedCard = ministryCard.trim();
                            // Use includes for better performance
                            if (!emrHealthCardsArray.includes(trimmedCard)) {
                                mohOnlyResults.push(ministryHealthCards[i]);
                            }
                        }
                    }
                    console.log(`Ministry-Only Results: ${mohOnlyResults.length} patients`);
                }
                
                // Skip Non-OHIP analysis - not needed
                nonOHIPResults = [];
                
                // Store the additional results globally
                rosterEndResults = rosterEndPatients;
                newMinistryPatients = newPatientsFromMinistry;
                
                console.log('=== FINAL RESULTS ===');
                console.log(`EMR-only: ${analysisResults.length}`);
                console.log(`Ministry-only: ${mohOnlyResults.length}`);
                console.log(`Non-OHIP: ${nonOHIPResults.length}`);
                console.log(`Roster End patients: ${rosterEndResults.length}`);
                console.log(`New Ministry patients: ${newMinistryPatients.length}`);
                
                displayResults(analysisType);
                
                // Calculate additional statistics
                const totalEMRPatients = emrPatients.length;
                const totalMinistryPatients = ministryHealthCards.length;
                const patientsInBoth = totalEMRPatients - analysisResults.length;
                
                const statusMessage = `Analysis complete! Processed ${totalEMRPatients} EMR patients and ${totalMinistryPatients} Ministry patients. Found ${analysisResults.length} patients on EMR roster but not on MOH list (candidates for q200 rostering), and ${mohOnlyResults.length} patients on MOH list but not on EMR roster (may have left your practice). ${patientsInBoth} patients are on both rosters.`;
                
                showStatus(statusMessage, 'success');
                
            } catch (error) {
                console.error('Analysis error:', error);
                showStatus(`Error during analysis: ${error.message}`, 'error');
            }
        }

        async function parseEMRFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const data = e.target.result;
                        let patients = [];
                        
                        if (file.name.endsWith('.csv')) {
                            patients = parseCSVData(data);
                        } else {
                            throw new Error('Only CSV files are supported. Please save your Excel file as CSV format and try again.');
                        }
                        
                        resolve(patients);
                    } catch (error) {
                        reject(new Error('Failed to parse EMR file: ' + error.message));
                    }
                };
                
                reader.onerror = () => reject(new Error('Failed to read EMR file'));
                reader.readAsText(file);
            });
        }

        async function parseMinistryFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const xmlData = e.target.result;
                        const healthCards = parseXMLData(xmlData);
                        resolve(healthCards);
                    } catch (error) {
                        reject(new Error('Failed to parse Ministry file: ' + error.message));
                    }
                };
                
                reader.onerror = () => reject(new Error('Failed to read Ministry file'));
                reader.readAsText(file);
            });
        }

        // Health card processing functions (adapted from Python)
        function cleanHealthNumber(healthNumber) {
            if (!healthNumber || typeof healthNumber !== 'string') {
                return '';
            }
            return healthNumber.toUpperCase().replace(/[^A-Z0-9]/g, '');
        }

        function extractOHIP(cleanedNumber) {
            // Look for 10-digit numbers (OHIP format)
            const match = cleanedNumber.match(/(\d{10})/);
            return match ? match[1] : '';
        }

        function extractRAMQ(cleanedNumber) {
            // Look for 4 letters followed by 8 digits (RAMQ format)
            const match = cleanedNumber.match(/([A-Z]{4}\d{8})/);
            return match ? match[1] : '';
        }
        
        function extractAnyHealthCard(cleanedNumber) {
            // More flexible health card extraction
            // Try OHIP first (10 digits)
            let match = cleanedNumber.match(/(\d{10})/);
            if (match) return match[1];
            
            // Try RAMQ (4 letters + 8 digits)
            match = cleanedNumber.match(/([A-Z]{4}\d{8})/);
            if (match) return match[1];
            
            // Try other patterns - 9 digits (some systems)
            match = cleanedNumber.match(/(\d{9})/);
            if (match) return match[1];
            
            // Try 11 digits (some systems with check digit)
            match = cleanedNumber.match(/(\d{11})/);
            if (match) return match[1];
            
            // Try any sequence of 8+ digits
            match = cleanedNumber.match(/(\d{8,})/);
            if (match) return match[1];
            
            return '';
        }
        
        function debugHealthCardDetection(healthNumberRaw, cleanedHN, ohipMatch, ramqMatch, patientName) {
            console.log(`Health Card Debug:`, {
                raw: healthNumberRaw,
                cleaned: cleanedHN,
                ohip: ohipMatch,
                ramq: ramqMatch,
                patient: patientName,
                length: cleanedHN.length
            });
        }
        
        function parseCSVLine(line) {
            // Properly parse CSV line handling quoted fields with commas
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current); // Add the last field
            return result;
        }

        function autoDetectEMRType(headers) {
            // Auto-detect EMR type based on column headers
            const headerStr = headers.join(' ').toLowerCase();
            
            if (headerStr.includes('patient identification value')) {
                return 'TELUS CHR';
            } else if (headerStr.includes('hcn')) {
                return 'OSCAR PRO';
            } else if (headerStr.includes('phn')) {
                return 'QHR ACCURO';
            } else if (headerStr.includes('surname') && headerStr.includes('health number')) {
                return 'TELUS PSS';
            } else {
                return 'Other EMR';
            }
        }

        function parseCSVData(csvText) {
            console.log('=== EMR FILE PROCESSING ===');
            console.log('🔍 DEBUGGING: Starting CSV parsing...');
            
            // Clean up the text to handle encoding issues
            let cleanText = csvText;
            
            // Remove BOM (Byte Order Mark) if present
            if (cleanText.charCodeAt(0) === 0xFEFF) {
                cleanText = cleanText.slice(1);
            }
            
            // Replace common encoding issues
            cleanText = cleanText
                .replace(/\uFFFD/g, '') // Remove replacement characters
                .replace(/[\u0000-\u001F\u007F-\u009F]/g, '') // Remove control characters
                .replace(/\r\n/g, '\n') // Normalize line endings
                .replace(/\r/g, '\n');
            
            const lines = cleanText.split('\n');
            console.log(`Total lines in file: ${lines.length}`);
            
            // Debug: Check the actual structure
            if (lines.length === 1) {
                const columnCount = lines[0].split(',').length;
                console.log(`Single line detected with ${columnCount} columns`);
                console.log(`First 100 characters: ${lines[0].substring(0, 100)}`);
            }
            
            // Check if file is corrupted (single line with many columns)
            if (lines.length === 1 && lines[0].split(',').length > 100) {
                console.log('WARNING: File appears to be corrupted - single line with many columns');
                console.log('Attempting to extract health card numbers directly from corrupted data...');
                
                const allText = lines[0];
                console.log('First 200 characters of corrupted data:', allText.substring(0, 200));
                console.log('Last 200 characters of corrupted data:', allText.substring(allText.length - 200));
                
                // Try multiple regex patterns to find health card numbers
                const patterns = [
                    /\d{10}/g,           // Standard 10-digit OHIP
                    /\d{9}/g,            // 9-digit numbers
                    /\d{8}/g,            // 8-digit numbers
                    /\d{11}/g,           // 11-digit numbers
                    /\d{7,12}/g          // 7-12 digit numbers
                ];
                
                let healthCardMatches = [];
                let bestPattern = null;
                
                for (let i = 0; i < patterns.length; i++) {
                    const matches = allText.match(patterns[i]);
                    console.log(`Pattern ${i + 1} (${patterns[i]}) found ${matches ? matches.length : 0} matches`);
                    
                    if (matches && matches.length > healthCardMatches.length) {
                        healthCardMatches = matches;
                        bestPattern = patterns[i];
                    }
                }
                
                console.log(`Best pattern: ${bestPattern} found ${healthCardMatches.length} matches`);
                console.log('Sample matches:', healthCardMatches.slice(0, 10));
                
                if (healthCardMatches.length > 0) {
                    // Filter to only 10-digit numbers (OHIP standard)
                    const ohipNumbers = healthCardMatches.filter(num => num.length === 10);
                    console.log(`Filtered to ${ohipNumbers.length} 10-digit OHIP numbers`);
                    
                    if (ohipNumbers.length > 0) {
                        // Parse the corrupted CSV data properly to extract names with health cards
                        const patients = [];
                        
                        // Split the data by health card numbers to get individual patient records
                        const healthCardPattern = /\d{10}/g;
                        const records = [];
                        let lastIndex = 0;
                        let match;
                        
                        while ((match = healthCardPattern.exec(allText)) !== null) {
                            const healthCard = match[0];
                            const healthCardIndex = match.index;
                            
                            // Find the start of this patient record by looking backwards for the previous health card or record separator
                            let recordStart = 0;
                            if (patients.length > 0) {
                                // Look for the previous health card or a clear record separator
                                const prevHealthCard = patients[patients.length - 1].healthCard;
                                const prevIndex = allText.lastIndexOf(prevHealthCard, healthCardIndex - 1);
                                if (prevIndex !== -1) {
                                    // Find the end of the previous record (look for the next comma after the previous health card)
                                    const afterPrevHealthCard = allText.indexOf(',', prevIndex + prevHealthCard.length);
                                    if (afterPrevHealthCard !== -1) {
                                        recordStart = afterPrevHealthCard + 1;
                                    }
                                }
                            }
                            
                            // Extract just this patient's record
                            const recordEnd = allText.indexOf(',', healthCardIndex + healthCard.length);
                            const recordText = allText.substring(recordStart, recordEnd !== -1 ? recordEnd : healthCardIndex + healthCard.length + 50);
                            
                            // Extract name from the record - look for the pattern before the health card
                            const beforeHealthCard = recordText.substring(0, recordText.indexOf(healthCard));
                            const parts = beforeHealthCard.split(',');
                            
                            // Debug: Show the parts for first few patients
                            if (patients.length < 3) {
                                console.log(`🔍 Record for health card ${healthCard}:`, recordText);
                                console.log(`🔍 Parts before health card:`, parts.slice(-10));
                            }
                            
                            // Look for two consecutive name parts immediately before the health card
                            let firstName = '';
                            let lastName = '';
                            
                            // Start from the end and work backwards to find the names immediately before the health card
                            for (let i = parts.length - 1; i >= 2; i--) {
                                const part1 = parts[i]?.trim();
                                const part2 = parts[i-1]?.trim();
                                
                                // Check if these look like proper names (letters only, reasonable length, not common non-name words)
                                const nonNameWords = ['MALE', 'FEMALE', 'M', 'F', 'CAN', 'ON', 'QC', 'BC', 'AB', 'MB', 'SK', 'NB', 'NS', 'PE', 'NL', 'YT', 'NT', 'NU', 'KEVIN', 'BROPHY', 'ROSTERED', 'CONNECT_APP', 'EMAIL', 'BOTH'];
                                
                                // More flexible name detection - allow for names with apostrophes, hyphens, and common name patterns
                                const isNamePattern = /^[A-Za-z\s\-'\.]+$/;
                                
                                if (part1 && part2 && 
                                    isNamePattern.test(part1) && 
                                    isNamePattern.test(part2) &&
                                    part1.length >= 2 && part1.length <= 30 &&
                                    part2.length >= 2 && part2.length <= 30 &&
                                    !nonNameWords.includes(part1.toUpperCase()) &&
                                    !nonNameWords.includes(part2.toUpperCase()) &&
                                    // Make sure they're not numbers or common data fields
                                    !/^\d+$/.test(part1) && !/^\d+$/.test(part2) &&
                                    !part1.includes('@') && !part2.includes('@') &&
                                    !part1.includes('+1') && !part2.includes('+1')) {
                                    lastName = part1;
                                    firstName = part2;
                                    
                                    if (patients.length < 3) {
                                        console.log(`✅ Found names: "${firstName} ${lastName}" from parts ${i-1} and ${i}`);
                                    }
                                    break;
                                }
                            }
                            
                            const patientName = firstName && lastName ? `${firstName} ${lastName}` : `Patient ${patients.length + 1}`;
                            
                            patients.push({
                                healthCard: healthCard,
                                name: patientName
                            });
                            
                            // Debug first few and any that don't get proper names
                            if (patients.length <= 3 || !firstName || !lastName) {
                                console.log(`Patient ${patients.length}: ${healthCard} -> "${patientName}"`);
                                console.log(`Full record context: ${recordText}`);
                                if (!firstName || !lastName) {
                                    console.log(`❌ Failed to extract name - First: "${firstName}", Last: "${lastName}"`);
                                    console.log(`All parts before health card:`, parts);
                                }
                                console.log(`---`);
                            }
                        }
                        
                        console.log(`Created ${patients.length} patients from extracted health cards`);
                        console.log('Sample patients:', patients.slice(0, 3));
                        
                        return patients;
                    } else {
                        // If no 10-digit numbers, use the best matches we found
                        console.log('No 10-digit numbers found, using best matches available');
                        const patients = healthCardMatches.slice(0, 1000).map((healthCard, index) => {
                            // Try to extract names for non-10-digit numbers too
                            let patientName = `Patient ${index + 1}`;
                            
                            const healthCardIndex = allText.indexOf(healthCard);
                            if (healthCardIndex !== -1) {
                                const startIndex = Math.max(0, healthCardIndex - 100);
                                const endIndex = Math.min(allText.length, healthCardIndex + 100);
                                const contextText = allText.substring(startIndex, endIndex);
                                
                                const nameMatch = contextText.match(/([A-Za-z]+),?\s+([A-Za-z]+),?\s+[^,]*,\s*'?([A-Za-z\s]+)'?,\s*\d{7,12}/);
                                if (nameMatch) {
                                    const firstName = nameMatch[1];
                                    const lastName = nameMatch[2];
                                    const fullName = nameMatch[3];
                                    
                                    if (fullName && fullName.trim() !== '') {
                                        patientName = fullName.trim();
                                    } else if (firstName && lastName) {
                                        patientName = `${firstName} ${lastName}`;
                                    }
                                }
                            }
                            
                            return {
                                healthCard: healthCard,
                                name: patientName
                            };
                        });
                        
                        console.log(`Created ${patients.length} patients from available matches`);
                        return patients;
                    }
                } else {
                    // Try to find any numbers at all
                    const anyNumbers = allText.match(/\d+/g);
                    console.log(`Found ${anyNumbers ? anyNumbers.length : 0} total numbers in file`);
                    console.log('Sample numbers:', anyNumbers ? anyNumbers.slice(0, 20) : 'None');
                    
                    if (anyNumbers && anyNumbers.length > 0) {
                        // Use the first 1000 numbers as health cards
                        const patients = anyNumbers.slice(0, 1000).map((healthCard, index) => ({
                            healthCard: healthCard,
                            name: `Patient ${index + 1}`
                        }));
                        
                        console.log(`Created ${patients.length} patients from all available numbers`);
                        return patients;
                    } else {
                        throw new Error('Could not extract any numbers from corrupted EMR file. Please try uploading a different file format.');
                    }
                }
            }
            
            // Find header row and parse headers
            let headerRow = -1;
            let headers = [];
            
            for (let i = 0; i < Math.min(5, lines.length); i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                headers = parseCSVLine(line).map(h => h.trim().replace(/"/g, ''));
                console.log(`Row ${i} headers:`, headers.slice(0, 10)); // Show first 10 headers only
                
                // Check if this looks like a header row (contains text, not just numbers)
                const hasTextHeaders = headers.some(h => /[A-Za-z]/.test(h));
                if (hasTextHeaders) {
                    headerRow = i;
                    break;
                }
            }
            
            if (headerRow === -1) {
                throw new Error('Could not find header row in EMR file. File may be corrupted or in wrong format.');
            }
            
            console.log(`Using row ${headerRow} as headers (first 10):`, headers.slice(0, 10));
            
            // Find OHIP number column
            let ohipColumn = -1;
            const ohipHeaders = [
                'patient identification value', 'hcn', 'phn', 'health number', 
                'health card', 'health card number', 'ohip', 'ohip number',
                'patient id', 'patient identifier', 'id', 'identifier',
                'healthcard', 'ohipnumber', 'patient_identifier', 'health_number'
            ];
            
            for (let i = 0; i < headers.length; i++) {
                const header = headers[i].toLowerCase();
                if (ohipHeaders.some(h => header.includes(h))) {
                    ohipColumn = i;
                    console.log(`Found OHIP column at index ${i}: "${headers[i]}"`);
                    break;
                }
            }
            
            // If not found by header, analyze data to find OHIP column
            if (ohipColumn === -1) {
                console.log('OHIP column not found by header, analyzing data...');
                let bestColumn = -1;
                let bestScore = 0;
                
                for (let col = 0; col < headers.length; col++) {
                    let score = 0;
                    let totalRows = 0;
                    
                    // Check first 10 data rows
                    for (let row = headerRow + 1; row < Math.min(headerRow + 11, lines.length); row++) {
                        const line = lines[row].trim();
                        if (!line) continue;
                        
                        const columns = parseCSVLine(line);
                        if (columns[col]) {
                            totalRows++;
                            const value = columns[col].replace(/\s/g, '');
                            
                            // Score based on OHIP patterns
                            if (/^\d{10}$/.test(value)) {
                                score += 10; // Perfect 10-digit number
                            } else if (/\d{10}/.test(value)) {
                                score += 5; // Contains 10 digits
                            } else if (/\d{8,}/.test(value)) {
                                score += 2; // Contains 8+ digits
                            }
                        }
                    }
                    
                    const scorePerRow = totalRows > 0 ? score / totalRows : 0;
                    console.log(`Column ${col} (${headers[col]}): score ${scorePerRow.toFixed(2)}`);
                    
                    if (scorePerRow > bestScore) {
                        bestScore = scorePerRow;
                        bestColumn = col;
                    }
                }
                
                if (bestColumn !== -1 && bestScore > 2) {
                    ohipColumn = bestColumn;
                    console.log(`Selected column ${bestColumn} (${headers[bestColumn]}) as OHIP column with score ${bestScore.toFixed(2)}`);
                } else {
                    throw new Error(`Could not find OHIP column. Available columns: ${headers.join(', ')}`);
                }
            }
            
            // Find name columns
            let firstNameColumn = -1;
            let lastNameColumn = -1;
            let fullNameColumn = -1;
            
            const firstNameHeaders = ['first name', 'given name', 'first_name', 'given_name', 'fname', 'preferred name', 'preferred_name', 'nickname'];
            const lastNameHeaders = ['last name', 'surname', 'last_name', 'surname', 'lname', 'family name', 'family_name'];
            const fullNameHeaders = ['patient name', 'full name', 'name', 'patient_name', 'full_name', 'patientname', 'complete name', 'complete_name'];
            
            for (let i = 0; i < headers.length; i++) {
                const header = headers[i].toLowerCase();
                if (firstNameHeaders.some(h => header.includes(h))) {
                    firstNameColumn = i;
                    console.log(`Found First Name column at index ${i}: "${headers[i]}"`);
                } else if (lastNameHeaders.some(h => header.includes(h))) {
                    lastNameColumn = i;
                    console.log(`Found Last Name column at index ${i}: "${headers[i]}"`);
                } else if (fullNameHeaders.some(h => header.includes(h))) {
                    fullNameColumn = i;
                    console.log(`Found Full Name column at index ${i}: "${headers[i]}"`);
                }
            }
            
            console.log(`Name columns - First: ${firstNameColumn}, Last: ${lastNameColumn}, Full: ${fullNameColumn}`);
            console.log(`Health card column: ${ohipColumn}`);
            console.log('All CSV headers:', headers);
            
            if (ohipColumn === -1) {
                console.log('⚠️ WARNING: No health card column found. Looking for columns containing numbers...');
                // Try to find any column that might contain health card numbers
                for (let i = 0; i < headers.length; i++) {
                    const header = headers[i].toLowerCase();
                    if (header.includes('number') || header.includes('id') || header.includes('card')) {
                        console.log(`Potential health card column ${i}: "${headers[i]}"`);
                    }
                }
            }
            
            // Process data rows
            const patients = [];
            
            for (let i = headerRow + 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const columns = parseCSVLine(line);
                
                if (columns.length <= ohipColumn) continue;
                
                const ohipRaw = columns[ohipColumn];
                if (!ohipRaw) continue;
                
                // Extract 10-digit OHIP number
                const ohipMatch = ohipRaw.match(/\d{10}/);
                if (!ohipMatch) {
                    if (patients.length < 3) {
                        console.log(`No OHIP match found for: "${ohipRaw}"`);
                    }
                    continue;
                }
                
                const ohipNumber = ohipMatch[0];
                
                // Debug: Show extraction process
                if (patients.length < 3) {
                    console.log(`OHIP extraction: "${ohipRaw}" -> "${ohipNumber}"`);
                }
                
                // Get patient name with enhanced logic
                let patientName = 'Unknown';
                
                if (fullNameColumn >= 0 && columns[fullNameColumn]) {
                    patientName = columns[fullNameColumn].trim();
                    console.log(`Using full name column ${fullNameColumn}: "${patientName}"`);
                } else if (firstNameColumn >= 0 && lastNameColumn >= 0) {
                    const firstName = columns[firstNameColumn] || '';
                    const lastName = columns[lastNameColumn] || '';
                    
                    // Check if there's a preferred name column
                    let preferredName = '';
                    for (let j = 0; j < headers.length; j++) {
                        const header = headers[j].toLowerCase();
                        if (header.includes('preferred') || header.includes('nickname')) {
                            preferredName = columns[j] || '';
                            break;
                        }
                    }
                    
                    // Use preferred name if available, otherwise use first name
                    const displayFirstName = preferredName || firstName;
                    patientName = `${displayFirstName} ${lastName}`.trim();
                    console.log(`Combining names: "${displayFirstName}" + "${lastName}" = "${patientName}"`);
                } else if (firstNameColumn >= 0) {
                    patientName = columns[firstNameColumn] || 'Unknown';
                    console.log(`Using first name only: "${patientName}"`);
                } else if (lastNameColumn >= 0) {
                    patientName = columns[lastNameColumn] || 'Unknown';
                    console.log(`Using last name only: "${patientName}"`);
                } else {
                    console.log('No name columns found, using "Unknown"');
                }
                
                patients.push({
                    healthCard: ohipNumber,
                    name: patientName
                });
                
                // Debug first few patients
                if (patients.length <= 3) {
                    console.log(`Patient ${patients.length}: OHIP=${ohipNumber}, Name="${patientName}"`);
                }
            }
            
            console.log(`=== EMR PROCESSING COMPLETE ===`);
            console.log(`Total patients processed: ${patients.length}`);
            console.log(`Sample patients:`, patients.slice(0, 3));
            
            return patients;
        }

        function parseXMLData(xmlText) {
            console.log('=== MINISTRY XML PROCESSING ===');
            const mohData = [];
            const rosterEndPatients = []; // Patients who came off the roster
            const seenHealthNumbers = new Set(); // Track unique health numbers
            
            // Define reason codes that indicate patients should be removed from roster
            const removeFromRosterCodes = ['01D', '02D', '12D', '14D', '44D', '60D', '73D', '74D', '90D', '91D', '99D'];
            
            // Define consent statuses that indicate patients should be excluded
            const excludedConsentStatuses = ['R', 'N']; // R = Revoked, N = Ended by Ministry
            
            try {
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
                
                // Handle Cognos XML namespace (from Python code)
                const namespace = 'http://developer.cognos.com/schemas/xmldata/1/';
                
                // Find metadata items to get headers
                const metadataItems = xmlDoc.querySelectorAll('metadata item');
                const headers = Array.from(metadataItems).map(item => item.getAttribute('name'));
                
                console.log('XML Headers found:', headers);
                
                if (!headers || headers.length === 0) {
                    throw new Error('Invalid MOH XML file. No column headers found in the <metadata> section.');
                }
                
                // Find data rows
                const valueNodes = xmlDoc.querySelectorAll('data row value');
                console.log(`Total value nodes found: ${valueNodes.length}`);
                
                let totalProcessed = 0;
                let validPatients = 0;
                let excludedByReasonCode = 0;
                let excludedByConsent = 0;
                let excludedByInvalidHealthCard = 0;
                let excludedByRosterEnd = 0;
                let duplicates = 0;
                
                for (let i = 0; i < valueNodes.length; i += headers.length) {
                    const rowValues = [];
                    for (let j = 0; j < headers.length; j++) {
                        const node = valueNodes[i + j];
                        rowValues.push(node ? (node.textContent || '') : '');
                    }
                    
                    const rowDict = {};
                    headers.forEach((header, index) => {
                        rowDict[header] = rowValues[index];
                    });
                    
                    totalProcessed++;
                    const healthNumber = rowDict['Health Number'] || '';
                    const reasonCode = rowDict['Reason Code'] || '';
                    const consentStatus = rowDict['Consent Status'] || '';
                    const patientType = rowDict['Patient Type'] || '';
                    const rosterEnd = rowDict['Roster End'] || '';
                    const rosterStart = rowDict['Roster Start'] || '';
                    
                    // Skip if health number is invalid
                    if (!healthNumber || healthNumber.length !== 10 || !/^\d{10}$/.test(healthNumber)) {
                        excludedByInvalidHealthCard++;
                        continue;
                    }
                    
                    // Skip if already processed (duplicate)
                    if (seenHealthNumbers.has(healthNumber)) {
                        duplicates++;
                        continue;
                    }
                    
                    // Check if patient has roster end date (came off roster)
                    if (rosterEnd && rosterEnd.trim() !== '') {
                        excludedByRosterEnd++;
                        // Add to roster end results for separate reporting
                        rowDict['_exclusion_reason'] = 'Roster End';
                        rowDict['_exclusion_details'] = `Came off roster on: ${rosterEnd}`;
                        rowDict['_roster_end_date'] = rosterEnd;
                        rosterEndPatients.push(rowDict);
                        console.log(`Patient ${healthNumber} came off roster on: ${rosterEnd}`);
                        continue;
                    }
                    
                    // Skip if reason code indicates removal from roster
                    if (removeFromRosterCodes.includes(reasonCode)) {
                        excludedByReasonCode++;
                        console.log(`Excluded patient ${healthNumber} due to reason code: ${reasonCode} (REMOVE FROM ROSTER)`);
                        continue;
                    }
                    
                    // Skip if consent status indicates revoked or ended
                    if (excludedConsentStatuses.includes(consentStatus)) {
                        excludedByConsent++;
                        console.log(`Excluded patient ${healthNumber} due to consent status: ${consentStatus} (${consentStatus === 'R' ? 'REVOKED BY PATIENT' : 'ENDED BY MINISTRY'})`);
                        continue;
                    }
                    
                    // Check if this is a new patient (has roster start date)
                    if (rosterStart && rosterStart.trim() !== '') {
                        rowDict['_is_new_patient'] = true;
                        rowDict['_roster_start_date'] = rosterStart;
                        console.log(`New patient ${healthNumber} added to roster on: ${rosterStart}`);
                    }
                    
                    // Add valid patient to results
                    seenHealthNumbers.add(healthNumber);
                    validPatients++;
                    mohData.push(rowDict);
                    
                    // Debug first few patients
                    if (mohData.length <= 3) {
                        console.log(`Valid Ministry patient ${mohData.length}: ${healthNumber} (${rowDict['Patient Name'] || 'Unknown'}) - Reason: ${reasonCode || 'None'}, Consent: ${consentStatus || 'P'}, Type: ${patientType || 'Standard'}, Roster Start: ${rosterStart || 'N/A'}, Roster End: ${rosterEnd || 'N/A'}`);
                    }
                }
                
                console.log(`=== MINISTRY XML PROCESSING COMPLETE ===`);
                console.log(`Total rows processed: ${totalProcessed}`);
                console.log(`Valid patients (included): ${validPatients}`);
                console.log(`Excluded by roster end date: ${excludedByRosterEnd}`);
                console.log(`Excluded by reason code (REMOVE FROM ROSTER): ${excludedByReasonCode}`);
                console.log(`Excluded by consent status (Revoked/Ended): ${excludedByConsent}`);
                console.log(`Excluded by invalid health card: ${excludedByInvalidHealthCard}`);
                console.log(`Duplicates skipped: ${duplicates}`);
                console.log(`Sample patients:`, mohData.slice(0, 3));
                
                // Separate new patients
                const newPatients = mohData.filter(patient => patient._is_new_patient);
                
                // Return comprehensive data structure
                return {
                    activePatients: mohData,
                    newPatients: newPatients,
                    rosterEndPatients: rosterEndPatients,
                    statistics: {
                        totalProcessed: totalProcessed,
                        validPatients: validPatients,
                        excludedByRosterEnd: excludedByRosterEnd,
                        excludedByReasonCode: excludedByReasonCode,
                        excludedByConsent: excludedByConsent,
                        excludedByInvalidHealthCard: excludedByInvalidHealthCard,
                        duplicates: duplicates,
                        newPatientsCount: newPatients.length,
                        rosterEndCount: rosterEndPatients.length
                    }
                };
                
            } catch (xmlError) {
                console.log('Structured XML parsing failed, trying text extraction:', xmlError);
                
                // Fallback to simple text extraction
                const healthCardPattern = /\b\d{10}\b/g;
                const matches = xmlText.match(healthCardPattern);
                
                if (matches) {
                    const uniqueMatches = [...new Set(matches)];
                    console.log(`Fallback parsing found ${uniqueMatches.length} unique health numbers`);
                    return uniqueMatches;
                }
                
                throw new Error('Failed to parse MOH XML file. Please ensure it is a valid MOH roster file.');
            }
        }

        function displayResults(analysisType) {
            resultsSection.classList.add('active');
            const resultsContent = document.getElementById('resultsContent');
            resultsContent.innerHTML = '';


            // Always display EMR-only and MOH-only results
            displayAnalysisSection(`Patients on EMR Roster but Not on MOH List (${analysisResults.length})`, analysisResults, 'These patients are on your EMR list but not on the Ministry roster - consider rostering them with q200 if appropriate');
            displayAnalysisSection(`Patients on MOH List but Not on EMR Roster (${mohOnlyResults.length})`, mohOnlyResults, 'These patients are on the Ministry roster but not in your EMR - they may have left your practice');
            
            // Display new sections for roster end and new patients
            if (rosterEndResults.length > 0) {
                displayAnalysisSection(`Patients Who Came Off Ministry Roster (${rosterEndResults.length})`, rosterEndResults, 'These patients have come off the Ministry roster - you may want to remove them from your EMR roster or investigate why they left');
            }
            
        }

        function displayAnalysisSection(title, results, description) {
            const resultsContent = document.getElementById('resultsContent');
            
            const section = document.createElement('div');
            section.className = 'analysis-section-result';
            section.style.marginBottom = '30px';
            
            const sectionTitle = document.createElement('h4');
            sectionTitle.textContent = title;
            sectionTitle.style.color = '#2c3e50';
            sectionTitle.style.marginBottom = '10px';
            
            const sectionDescription = document.createElement('p');
            sectionDescription.textContent = description;
            sectionDescription.style.color = '#6c757d';
            sectionDescription.style.marginBottom = '15px';
            sectionDescription.style.fontStyle = 'italic';
            
            const patientList = document.createElement('div');
            patientList.className = 'patient-list';
            
            if (results.length === 0) {
                patientList.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 20px;">No patients found in this category.</p>';
            } else {
                results.forEach((patient, index) => {
                    const patientItem = document.createElement('div');
                    patientItem.className = 'patient-item';
                    
                    let patientName, healthCard, reasonCode, consentStatus, patientType, rosterStart, rosterEnd;
                    if (typeof patient === 'string') {
                        // Ministry-only results might be just health card numbers
                        healthCard = patient;
                        patientName = 'Unknown';
                        reasonCode = '';
                        consentStatus = '';
                        patientType = '';
                        rosterStart = '';
                        rosterEnd = '';
                    } else {
                        healthCard = patient.healthCard || patient['Health Number'];
                        patientName = patient.name || patient['Patient Name'] || 'Unknown';
                        reasonCode = patient['Reason Code'] || '';
                        consentStatus = patient['Consent Status'] || '';
                        patientType = patient['Patient Type'] || '';
                        rosterStart = patient['Roster Start'] || patient['_roster_start_date'] || '';
                        rosterEnd = patient['Roster End'] || patient['_roster_end_date'] || '';
                        
                        // Debug logging for first few patients
                        if (index < 3) {
                            console.log(`Patient ${index + 1} data:`, patient);
                            console.log(`Patient ${index + 1} name: "${patientName}", healthCard: "${healthCard}"`);
                        }
                    }
                    
                    // Create additional info display
                    let additionalInfo = '';
                    if (reasonCode || consentStatus || patientType || rosterStart || rosterEnd) {
                        const infoParts = [];
                        if (reasonCode) infoParts.push(`Reason: ${reasonCode}`);
                        if (consentStatus) {
                            const statusText = consentStatus === 'P' ? 'PENDING' : 
                                             consentStatus === 'R' ? 'REVOKED' : 
                                             consentStatus === 'N' ? 'ENDED' : consentStatus;
                            infoParts.push(`Consent: ${statusText}`);
                        }
                        if (patientType) {
                            const typeText = patientType === 'LTC' ? 'LONG-TERM CARE' :
                                           patientType === 'FHG' ? 'FHG ASSIGNED' :
                                           patientType === 'FEP' ? 'FRAIL ELDERLY' :
                                           patientType === 'PME' ? 'PRE-MEMBER' : patientType;
                            infoParts.push(`Type: ${typeText}`);
                        }
                        if (rosterStart) {
                            infoParts.push(`Roster Start: ${rosterStart}`);
                        }
                        if (rosterEnd) {
                            infoParts.push(`Roster End: ${rosterEnd}`);
                        }
                        if (infoParts.length > 0) {
                            additionalInfo = `<div class="patient-additional-info" style="font-size: 0.85em; color: #666; margin-top: 5px;">${infoParts.join(' • ')}</div>`;
                        }
                    }
                    
                    patientItem.innerHTML = `
                        <div class="patient-info">
                            <div class="health-card">${healthCard}</div>
                            <div class="patient-name">${patientName}</div>
                            ${additionalInfo}
                        </div>
                    `;
                    patientList.appendChild(patientItem);
                });
            }
            
            section.appendChild(sectionTitle);
            section.appendChild(sectionDescription);
            section.appendChild(patientList);
            resultsContent.appendChild(section);
        }

        function exportResults(format) {
            let content = '';
            let filename = '';
            const mimeType = 'text/csv';
            const dateStr = new Date().toISOString().split('T')[0];

            // Export all results with additional fields including roster dates
            content = 'Analysis Type,Health Card Number,Patient Name,Reason Code,Consent Status,Patient Type,Roster Start,Roster End,Description\n';
            
            // EMR Only
            analysisResults.forEach(patient => {
                const healthCard = patient.healthCard || '';
                const name = patient.name || 'Unknown';
                const reasonCode = patient['Reason Code'] || '';
                const consentStatus = patient['Consent Status'] || '';
                const patientType = patient['Patient Type'] || '';
                const rosterStart = patient['Roster Start'] || '';
                const rosterEnd = patient['Roster End'] || '';
                content += `EMR Only,"${healthCard}","${name}","${reasonCode}","${consentStatus}","${patientType}","${rosterStart}","${rosterEnd}",Patients in EMR but not on Ministry roster\n`;
            });
            
            // Ministry Only
            mohOnlyResults.forEach(patient => {
                const healthCard = typeof patient === 'string' ? patient : (patient['Health Number'] || '');
                const name = typeof patient === 'string' ? 'Unknown' : (patient['Patient Name'] || 'Unknown');
                const reasonCode = typeof patient === 'string' ? '' : (patient['Reason Code'] || '');
                const consentStatus = typeof patient === 'string' ? '' : (patient['Consent Status'] || '');
                const patientType = typeof patient === 'string' ? '' : (patient['Patient Type'] || '');
                const rosterStart = typeof patient === 'string' ? '' : (patient['Roster Start'] || '');
                const rosterEnd = typeof patient === 'string' ? '' : (patient['Roster End'] || '');
                content += `Ministry Only,"${healthCard}","${name}","${reasonCode}","${consentStatus}","${patientType}","${rosterStart}","${rosterEnd}",Patients on Ministry roster but not in EMR\n`;
            });
            
            // Roster End Patients
            rosterEndResults.forEach(patient => {
                const healthCard = patient['Health Number'] || '';
                const name = patient['Patient Name'] || 'Unknown';
                const reasonCode = patient['Reason Code'] || '';
                const consentStatus = patient['Consent Status'] || '';
                const patientType = patient['Patient Type'] || '';
                const rosterStart = patient['Roster Start'] || '';
                const rosterEnd = patient['Roster End'] || patient['_roster_end_date'] || '';
                content += `Roster End,"${healthCard}","${name}","${reasonCode}","${consentStatus}","${patientType}","${rosterStart}","${rosterEnd}",Patients who came off Ministry roster\n`;
            });
            
            
            filename = `roster-optimizer-results-${dateStr}.csv`;

            if (!content || content === 'Analysis Type,Health Card Number,Patient Name,Reason Code,Consent Status,Patient Type,Description\n') {
                showStatus('No data to export', 'error');
                return;
            }

            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showStatus(`Results exported as ${format.toUpperCase()} with detailed filtering information`, 'success');
        }

        function newAnalysis() {
            clearFiles();
            showStatus('Ready for new analysis', 'info');
        }

        function toggleHelp() {
            helpSection.classList.toggle('active');
            if (helpSection.classList.contains('active')) {
                showHelpBtn.textContent = 'Hide EMR Instructions';
            } else {
                showHelpBtn.textContent = 'Click here for EMR instructions';
            }
        }

        function toggleMinistryHelp() {
            ministryHelpSection.classList.toggle('active');
            if (ministryHelpSection.classList.contains('active')) {
                showMinistryHelpBtn.textContent = 'Hide MOH Instructions';
            } else {
                showMinistryHelpBtn.textContent = 'Click here for MOH download instructions';
            }
        }

        function showStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = `status-message ${type}`;
            statusMessage.style.display = 'block';
            
            setTimeout(() => {
                statusMessage.style.display = 'none';
            }, 5000);
        }

        // Help tab functionality
        function initHelpTabs() {
            const helpTabs = document.querySelectorAll('.help-tab');
            const helpContents = document.querySelectorAll('.help-content');
            
            helpTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // Remove active class from all tabs and contents
                    helpTabs.forEach(t => t.classList.remove('active'));
                    helpContents.forEach(c => c.classList.remove('active'));
                    
                    // Add active class to clicked tab
                    tab.classList.add('active');
                    
                    // Show corresponding content
                    const tabId = tab.getAttribute('data-tab');
                    const content = document.getElementById(tabId);
                    if (content) {
                        content.classList.add('active');
                    }
                });
            });
        }

        // Search functionality for help content
        function searchHelp() {
            const searchTerm = document.getElementById('helpSearch').value.toLowerCase().trim();
            const helpSections = document.querySelectorAll('#helpContent .help-section');
            
            if (!searchTerm) {
                // Show all sections if no search term
                helpSections.forEach(section => {
                    section.style.display = 'block';
                    section.style.backgroundColor = '';
                });
                return;
            }
            
            let foundCount = 0;
            helpSections.forEach(section => {
                const keywords = section.getAttribute('data-keywords') || '';
                const content = section.textContent.toLowerCase();
                
                if (keywords.includes(searchTerm) || content.includes(searchTerm)) {
                    section.style.display = 'block';
                    section.style.backgroundColor = '#fff3cd';
                    foundCount++;
                } else {
                    section.style.display = 'none';
                }
            });
            
            // Show search results message
            const helpContent = document.getElementById('helpContent');
            let resultMessage = helpContent.querySelector('.search-results');
            if (!resultMessage) {
                resultMessage = document.createElement('div');
                resultMessage.className = 'search-results';
                resultMessage.style.cssText = 'background-color: #d1ecf1; border: 1px solid #bee5eb; border-radius: 4px; padding: 10px; margin-bottom: 15px; color: #0c5460;';
                helpContent.insertBefore(resultMessage, helpContent.firstChild);
            }
            
            if (foundCount > 0) {
                resultMessage.textContent = `Found ${foundCount} section(s) matching "${searchTerm}"`;
                resultMessage.style.display = 'block';
            } else {
                resultMessage.textContent = `No sections found matching "${searchTerm}"`;
                resultMessage.style.display = 'block';
            }
        }

        function clearSearch() {
            document.getElementById('helpSearch').value = '';
            const helpSections = document.querySelectorAll('#helpContent .help-section');
            const resultMessage = document.querySelector('.search-results');
            
            helpSections.forEach(section => {
                section.style.display = 'block';
                section.style.backgroundColor = '';
            });
            
            if (resultMessage) {
                resultMessage.style.display = 'none';
            }
        }

        // Add Enter key support for search
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('helpSearch');
            if (searchInput) {
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        searchHelp();
                    }
                });
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            showStatus('The Roster Optimizer ready - upload your EMR and Ministry files to begin', 'info');
            initHelpTabs();
        });
    </script>
</body>
</html>
